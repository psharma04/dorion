name: Homebrew Cask Auto-update

on:
  schedule:
    - cron: "0 0 * * *" # Runs daily at midnight UTC
  workflow_dispatch: # Allows manual trigger of the action

jobs:
  livecheck:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install Homebrew, check and update
      run: |
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        brew tap psharma04/dorion
        brew livecheck dorion
        NEW_VERSION=$(brew livecheck dorion --newer-only --json | jq -r '.[0].version')
        CURRENT_VERSION=$(grep -E '^  version' Casks/dorion.rb | awk '{print $2}' | tr -d '"')

        if [ "$NEW_VERSION" != "$CURRENT_VERSION" ]; then
          # Update the version and sha256 in the cask file
          sed -i '' "s/$CURRENT_VERSION/$NEW_VERSION/g" Casks/dorion.rb

          # Commit and push the changes directly to the main branch
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git checkout main
          git add Casks/dorion.rb
          git commit -m "Update Dorion cask to $NEW_VERSION"
          git push origin main
        else
          echo "No new version found"
        fi
